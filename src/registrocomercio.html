<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="stylesheet" href="css/style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar com√©rcio</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>

    <!-- Cabe√ßalho -->
    <header>
       <div class="logo">Guia do Bairro</div>
       <button class="btn-menu" aria-label="Abrir Menu">‚ò∞</button> 
       <form class="pesquisa" action="catalogo.html" method="GET">
            <input type="text" name="q" placeholder="Buscar no site...">
            <button type="submit">üîç</button>
        </form>
        <ul class="navegacao">
            <li><a href="index.html">P√°gina Inicial</a></li>
            <li><a href="catalogo.html">Cat√°logo</a></li>
            <li><a href="registrocomercio.html">Registrar Com√©rcio</a></li>
        </ul>
    </header>
    
    <main>
        <section>
            <form id="form-cadastro" class="formulario" novalidate>
                <div class="form-row">
                    <label for="nome-comercio">Nome do com√©rcio</label>
                    <input type="text" id="nome-comercio" name="nome-comercio" placeholder="Nos diga o nome do seu neg√≥cio" required>
                </div>

                <div class="form-row">
                    <label for="descricao">Descri√ß√£o:</label>
                    <textarea id="descricao" name="descricao" rows="4" cols="50" placeholder="Nos diga sobre seu neg√≥cio..."></textarea>
                </div>

                <div class="form-row">
                    <label for="categoria">Categoria</label>
                    <select id="categoria" name="categoria">
                        <option value="">Selecione uma categoria</option>
                        <option value="alimenta√ß√£o">üçî Alimenta√ß√£o</option>
                        <option value="sa√∫de">‚ù§Ô∏è Sa√∫de e Bem-Estar</option>
                        <option value="servicos-domesticos">üè† Servi√ßos Dom√©sticos</option>
                        <option value="educa√ß√£o">üìö Educa√ß√£o</option>
                        <option value="outros">‚öôÔ∏è Outros</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="horario">Hor√°rio de Funcionamento:</label>
                    <input type="text" id="horario" name="horario" placeholder="Ex: Seg-Sex: 8h √†s 18h">
                </div>

                <div class="form-row">
                    <label for="endereco">Endere√ßo</label>
                    <input type="text" id="endereco" name="endereco" placeholder="Ex: Rua das Flores, 123">
                </div>

                <div class="form-row">
                    <label for="contato">Meios de contato</label>
                    <input type="text" id="contato" name="contato" placeholder="Ex: (44) 1234-5678">
                </div>
                <input type="hidden" id="lat" name="lat">
                <input type="hidden" id="lng" name="lng">
                <div class="form-row">
                    <small>Clique no mapa para definir a localiza√ß√£o do com√©rcio.</small>
                    <div id="map-registro" aria-label="Mapa para selecionar coordenadas"></div>
                </div>

                <button type="submit">Cadastrar e adicionar ao mapa</button>
            </form>
        </section>
    </main>
    <!-- Rodap√© -->
    <footer class="rodape">
        <nav>
            <a href="sobre.html">Sobre</a> |
            <a href="ajuda.html">Ajuda</a> |
            <a href="politicadeprivacidade.html">Pol√≠tica de Privacidade</a>
        </nav>
    </footer>
    <script src="js/validacao.js"></script>
    <script src="js/main.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const defaultCenter = [-23.7570, -53.3200];
            const map = L.map('map-registro').setView(defaultCenter, 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            let marker;
            function placeMarker(latlng) {
                if (marker) marker.setLatLng(latlng);
                else marker = L.marker(latlng).addTo(map);
                document.getElementById('lat').value = latlng.lat.toFixed(6);
                document.getElementById('lng').value = latlng.lng.toFixed(6);
            }

            map.on('click', function(e) { placeMarker(e.latlng); });

            // Ao submeter o formul√°rio, salva no localStorage e redireciona para o mapa
            const form = document.getElementById('form-cadastro');
            form.addEventListener('submit', function(ev) {
                ev.preventDefault();
                // Se o validador j√° marcou erros, n√£o prossegue
                if (form.querySelectorAll && form.querySelectorAll('.erro').length > 0) {
                    // foca no primeiro erro
                    const primeiro = form.querySelector('.erro');
                    if (primeiro && primeiro.focus) primeiro.focus();
                    return;
                }
                const nome = document.getElementById('nome-comercio').value.trim();
                const categoria = document.getElementById('categoria').value;
                const endereco = document.getElementById('endereco').value.trim();
                const contato = document.getElementById('contato').value.trim();
                const horario = document.getElementById('horario').value.trim();
                const descricao = document.getElementById('descricao').value.trim();
                const lat = parseFloat(document.getElementById('lat').value);
                const lng = parseFloat(document.getElementById('lng').value);

                if (Number.isNaN(lat) || Number.isNaN(lng)) {
                    alert('Por favor selecione a localiza√ß√£o no mapa antes de cadastrar.');
                    return;
                }

                const novo = { nome, categoria, endereco, contato, horario, descricao, coords: [lat, lng], criadoEm: new Date().toISOString() };
                const chave = 'comercios';
                const atuais = JSON.parse(localStorage.getItem(chave) || '[]');
                atuais.push(novo);
                localStorage.setItem(chave, JSON.stringify(atuais));

                // Vai para a p√°gina inicial para ver o marcador
                window.location.href = 'index.html';
            });
        });
    </script>
</body>

</html>

